
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://pomeg-letterbombers.github.io/pokemon-ace-notes/technical-documentation/grab-ace-exit/">
      
      
        <link rel="prev" href="../writing-hexwriter/">
      
      
      
      <link rel="icon" href="../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>Grab ACE exit - pokemon-ace-notes</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2afb09e1.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+3:300,300i,400,400i,700,700i%7CSource+Code+Pro:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Source Sans 3";--md-code-font:"Source Code Pro"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#how-to-exit-ace" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="pokemon-ace-notes" class="md-header__button md-logo" aria-label="pokemon-ace-notes" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            pokemon-ace-notes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Grab ACE exit
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/pomeg-letterbombers/pokemon-ace-notes/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    pokemon-ace-notes
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="pokemon-ace-notes" class="md-nav__button md-logo" aria-label="pokemon-ace-notes" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    pokemon-ace-notes
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/pomeg-letterbombers/pokemon-ace-notes/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    pokemon-ace-notes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    FireRed/LeafGreen
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            FireRed/LeafGreen
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Getting started
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Getting started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frlg/getting-started/introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Exit codes
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Exit codes
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frlg/exit-codes/box-14-exit/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Box 14 exit code
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frlg/exit-codes/exit-code-bootstrap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exit code bootstrap
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Complex payloads
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Complex payloads
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../frlg/complex-payloads/hex-writer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hexwriter
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Technical documentation
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Technical documentation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../writing-hexwriter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Writing the hexwriter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Grab ACE exit
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Grab ACE exit
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-to-exit-ace" class="md-nav__link">
    <span class="md-ellipsis">
      How to exit ACE?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-of-this-exit" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation of this exit
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation of this exit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-standard-exits" class="md-nav__link">
    <span class="md-ellipsis">
      The standard exit(s)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#box-14-exit" class="md-nav__link">
    <span class="md-ellipsis">
      Box 14 exit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#improved-box-14-exit" class="md-nav__link">
    <span class="md-ellipsis">
      Improved box 14 exit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#r0-bootstrap" class="md-nav__link">
    <span class="md-ellipsis">
      r0 bootstrap
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#legacy-bootstrap" class="md-nav__link">
    <span class="md-ellipsis">
      Legacy bootstrap
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acknowledgements" class="md-nav__link">
    <span class="md-ellipsis">
      Acknowledgements
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#how-to-exit-ace" class="md-nav__link">
    <span class="md-ellipsis">
      How to exit ACE?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-of-this-exit" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation of this exit
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation of this exit">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-standard-exits" class="md-nav__link">
    <span class="md-ellipsis">
      The standard exit(s)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#box-14-exit" class="md-nav__link">
    <span class="md-ellipsis">
      Box 14 exit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#improved-box-14-exit" class="md-nav__link">
    <span class="md-ellipsis">
      Improved box 14 exit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#r0-bootstrap" class="md-nav__link">
    <span class="md-ellipsis">
      r0 bootstrap
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#legacy-bootstrap" class="md-nav__link">
    <span class="md-ellipsis">
      Legacy bootstrap
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acknowledgements" class="md-nav__link">
    <span class="md-ellipsis">
      Acknowledgements
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


  <h1>Grab ACE exit</h1>

<h2 id="how-to-exit-ace">How to exit ACE?</h2>
<p>Under normal circumstances, when swapping two Pokémon in the PC the game does the following:</p>
<ol>
<li>Sets the current <code>PokeStorageTask</code> to <a href="https://github.com/pret/pokefirered/blob/bf6bfbd2ed5ead6319cb8efcb537ac14d2b128d7/src/pokemon_storage_system_tasks.c#L1117"><code>Task_ShiftMon</code></a></li>
<li><code>Task_ShiftMon</code> calls <a href="https://github.com/pret/pokefirered/blob/bf6bfbd2ed5ead6319cb8efcb537ac14d2b128d7/src/pokemon_storage_system_data.c#L428"><code>DoMonPlaceChange</code></a>, waiting for the function to return <code>false</code> to continue.</li>
<li><code>DoMonPlaceChange</code> calls member <code>monPlaceChangeFunc</code> stored in <code>gStorage</code> which should normally be the pointer of<a href="https://github.com/pret/pokefirered/blob/bf6bfbd2ed5ead6319cb8efcb537ac14d2b128d7/src/pokemon_storage_system_data.c#L488"><code>MonPlaceChange_Shift</code></a> during a swap.<ul>
<li>The return type of <code>DoMonPlaceChange</code> is specified as <code>u8</code> (unsigned 8-bit integer).</li>
<li>A boolean’s numerical form is typically <code>0</code> is <code>false</code>, everything else is <code>true</code>.</li>
</ul>
</li>
<li><code>MonPlaceChange_Shift</code> does the actual operation of swapping the two Pokémon, eventually returning <code>false</code>, allowing <code>Task_ShiftMon</code> to continue and change the <code>PokeStorageTask</code> to <code>Task_PokeStorageMain</code>.</li>
</ol>
<p>However when perform this swap with a glitch Pokémon with a particularly long name, a few things happen:</p>
<ul>
<li>Parts of the long name overwrite the pointer stored in <code>monPlaceChangeFunc</code> each time the long name is loaded (which is after the first iteration of <code>DoMonPlaceChange</code> during an animation).</li>
<li>As a result when its time for <code>DoMonPlaceChange</code> to call <code>monPlaceChangeFunc</code>, it ends up jumping to whatever “pointer” the very long name happen to overwrite <code>monPlaceChangeFunc</code> to.</li>
<li>In most cases, this leads to a crash but for some (like species 0x351) this allows for arbitrary code execution!</li>
</ul>
<p>While arbitrary code execution is neat, once we done what we wanted to do, how do we safely return control back to the game?
If we look at what the game does normally while swapping two Pokémon, <code>Task_ShfitMon</code> which called the “pointer” that the long name wrote in is expecting a <code>u8</code> that equals to <code>false</code> which is <code>0</code>.
Translating this to GBA ARM assembly, at its simplest form, we get this:</p>
<div class="highlight"><pre><span></span><code>MOV r0, #0x0 ; setting return value to false, r0 is used as the return value
BX lr ; jump to return address
</code></pre></div>
<p>While this looks simple to implement, due to the circumstances of the ACE environment, the exit have been reimplemented in a number of different ways which will be covered in the next section.</p>
<h2 id="implementation-of-this-exit">Implementation of this exit</h2>
<h3 id="the-standard-exits">The standard exit(s)</h3>
<p>While <code>MOV r0, #0x0</code> is not writable in its standard form, <code>MOVS r0, #0x0</code> is (it sets the <code>Z</code> flag, but that does not matter).
<code>BIC r0, #0xFF</code> is also an acceptable alternative since the return type of <code>DoMonPlaceChange</code> is <code>u8</code>, clearing the lower 8 bits of <code>r0</code> is enough to return <code>false</code>.</p>
<p>However <code>BX lr</code> is not writable with the standard character set, glitchers have to come up with a way to be able to write <code>BX lr</code>.
The opcode for <code>BX lr</code> can be computed into a register then be stored in a word-aligned address <strong>after</strong> the current value of the <code>pc</code> register.
This means that the <code>STR</code> instruction must be located on the first half of Box 13, or earlier, as read-ahead will mean that the <code>BX lr</code> instruction will not be executed.
Thus while this method works, will also add to the length of the box name payload, the only upside to this method is that it works wihtout needing a genuine GBA BIOS.</p>
<details class="info">
<summary>BX lr computation instructions</summary>
<div class="highlight"><pre><span></span><code>E3E0B6EE    MVN r11, #0xEE00000
E2CBB0DF    SBC r11, #0xDF
E2CBB6FF    SBC r11, #0xFF00000 ; r11 = E12FFF1E (BX lr)
</code></pre></div>
<p>or this:</p>
<div class="highlight"><pre><span></span><code>E3E0B0E0    MVN r11, #0xE0
E3CBB6EE    BIC r11, #0xEE00000
E2CBB6FF    SBC r11, #0xFF00000 ; r11 = E12FFF1E (BX lr)
</code></pre></div>
</details>
<div class="admonition note inline end">
<p class="admonition-title">Note</p>
<p>There is also a BIOS jump for <code>BX r0</code>, the <code>MOVS</code> instruction looks like:</p>
<div class="highlight"><pre><span></span><code>E3B0FFC9    MOVS pc, #0x324
</code></pre></div>
</div>
<p>But merrp and luckytyphlosion found an even shorter method of executing <code>BX lr</code> with the limited character set available, calling <code>MOVS pc, &lt;immediate&gt;</code> with the immediate being the address of an ARM mode <code>BX lr</code>.
It just so happens that one such compatible address is located in the BIOS producing the following end result:</p>
<div class="highlight"><pre><span></span><code>E3B0FFD5    MOVS pc, #0x354
</code></pre></div>
<p>Which when combined with <code>MOVS r0, #0x0</code> looks like:</p>
<div class="highlight"><pre><span></span><code>E3B00000    MOVS r0, #0x0
E3B0FFD5    MOVS pc, #0x354
</code></pre></div>
<p>It also happens that <code>MOVS pc, &lt;immediate&gt;</code> is only writable using one of the EOF terminators, so with this exit code the code can be 3, 6 or 11 box names long.
In box name form, it looks like this:</p>
<div class="highlight"><pre><span></span><code>Box 10: _ _ _ _ _ … o a [     …oa]
Box 11: … o […o]
</code></pre></div>
<p>This form of the exit is also used, for codes that need to fit one more instruction then what the standard exit allows:</p>
<div class="highlight"><pre><span></span><code>E3C000FF    BIC r0, #0xFF ; r0 &amp; 0xFF = 0, set return value to false
; (insert extra unrelated instruction)
E3B0FFD5    MOVS pc, #0x354
</code></pre></div>
<p>In box name form, it looks like this:</p>
<div class="highlight"><pre><span></span><code>Box 10: _ F o * * * * a [ Fo****a]
Box 11: … o […o]
* = extra instruction
</code></pre></div>
<h3 id="box-14-exit">Box 14 exit</h3>
<p>This exit consists of the following instructions in the name of Box 14:</p>
<div class="highlight"><pre><span></span><code>E3C000FF    BIC r0, #0xFF ; set return value to false
E12FFF1E    BX lr
</code></pre></div>
<p>and in box form, it looks like this:</p>
<div class="highlight"><pre><span></span><code>Box 14: _ F o ì [ Foì]
</code></pre></div>
<p>Below are the instructions of the code used to setup the Box 14 exit</p>
<div class="highlight"><pre><span></span><code>E3E0B6EE    MVN r11, #0xEE00000
E2CBB0DF    SBC r11, #0xDF
E2CBB6FF    SBC r11, #0xFF00000 ; r11 = E12FFF1E
E2CFCFE2    SBC r12, pc, #0x388 ; r12 = Address of Box 14 name - 0x3ED
0000FF00    ; (filler)
E5ACB3ED    STR r11, [r12, #0x3ED]! ; Store BX LR in Box 14 name
...
E3C000FF    BIC r0, #0xFF
00000000    ; becomes BX lr (E12FFF1E)
</code></pre></div>
<h3 id="improved-box-14-exit">Improved box 14 exit</h3>
<p>Mettrich came up with this exit which does not require a set up code to write a BX instruction to the name of box 14.
Instead it just requires changing the name of Box 14 as well as changing the box wallpapers.
This code jumps to the <code>BX lr</code> instruction located in the GBA BIOS.</p>
<p>The exit consists of the following instructions:</p>
<div class="highlight"><pre><span></span><code>E3B0CFFF    MOVS r12, #0x3FC
E3B00000    MOVS r0, #0x0 ; set return value to false
020CFFD5    ANDEQ pc, r12, #0x354 ; jump to 0x354 (BX lr)
</code></pre></div>
<p>The box name component of the exit looks like this:</p>
<div class="highlight"><pre><span></span><code>Box 14: U … o _ _ … o a [U…o  …oa]
</code></pre></div>
<p>And below are the box wallpaper settings needed for the exit:</p>
<ul>
<li>Box 1: STARS (0x0C)</li>
<li>Box 2: DESERT (0x02)</li>
</ul>
<h3 id="r0-bootstrap"><code>r0</code> bootstrap</h3>
<p>The current exit code bootstrap (called the <code>r0</code> bootstrap to distinguish it from an older bootstrap) consists of two parts.
It is a shiny female Beedrill with name <code>Â␣␣nÔ␣␣v␣␣</code> and OT <code>␣î␣C␣␣␣</code>.</p>
<p>The nickname consists of the following instructions:</p>
<div class="highlight"><pre><span></span><code>E28F0003    ADD r0, pc, #0x3 ; sets r0 to address of OT
EA00000F    B pc+0x44
</code></pre></div>
<p>As bit 0 of <code>r0</code> is set; when a <code>BX r0</code> instruction is executed, the CPU will be executing instructions there in Thumb mode, rather than ARM.
Thumb mode allows the exit code written in the OT to be smaller byte-wise, and it also makes the setup code shorter as well.
The OT consists of the following Thumb instructions:</p>
<div class="highlight"><pre><span></span><code>2000    MOV r0, #0x0
BD00    POP {pc}
</code></pre></div>
<p>In this context, <code>POP {pc}</code> jumps to the middle of <code>Task_ShiftMon</code> where it checks whether the return value of <code>DoMonPlaceChange</code> evaluates to <code>false</code>, this is just another way of jumping to a return address (though it is not the same return address as the one defined in <code>lr</code>, which is located in the middle of <code>DoMonPlaceChange</code>).</p>
<p>Below is the instructions of the box name code used to create the bootstrap (note that it exits using a box 14 exit set up earlier):</p>
<div class="highlight"><pre><span></span><code>E2CFBDA5    SBC r11, pc, #0x2940 ; r11 = address of Box 10, Slot 19 + 9
E3B0CCE2    MOVS r12, #0xE200
E3CCCAFF    BIC r12, #0xFF000 ; r12 = 0200, hasSpecies set
E1CBC0BA    STRH r12, [r11, #0xA] ; Store hasSpecies flag
0000FF00    ; (filler)
E3B0C5E7    MOVS r12, #0x39C00000
00FF0000    ; (filler)
E2ACC3EA    ADC r12, #0xA8000003
FF000000    ; (filler)
E2ACC8CF    ADC r12, #0xCF0000 ; r12 = E28F0003 (ADD r0, pc, #0x3)
E5ABC000    STR r12, [r11]! ; Store in nickname chars 0-3
E3B0C0FF    MOVS r12, #0xFF
E2ABB3C0    ADC r11, #0x3 ; r11 = Box 10, Slot 19 + 12
0000FF00    ; (filler)
E2ACC4EA    ADC r12, #0xEA000000
00FF0000    ; (filler)
E3CCCECF    BIC r12, #0xCF0 ; r12 = EA00000F (B pc+0x44)
FF000000    ; (filler)
E1CBC1B0    STRH r12, [r11, #0x10] ; Store checksum
E1CBC1B4    STRH r12, [r11, #0x14] ; Store species
E3B0ACFF    MOVS r10, #0xFF00 ; Temporarily store in r10
E5ABC000    STR r12, [r11]! ; Store in nickname chars 4-7
0000FF00    ; (filler)
E2ABB2B0    ADC r11, #0xB ; r11 = Box 10, Slot 19 + 23
00FF0000    ; (filler)
E2AAC4BD    ADC r10, r12, #0xBD000000 ; move r10 into r12
FF000000    ; (filler)
E3CCCCDF    BIC r12, #0xDF00 ; r12 = BD002000 (MOV r0, #0 ; POP {pc})
E5ABC000    STR r12, [r11]! ; Store in OT
</code></pre></div>
<h3 id="legacy-bootstrap">Legacy bootstrap</h3>
<p>This bootstrap can be made in a variety of ways, but all it does is setting <code>r0</code> to <code>0</code> and uses a <code>BX lr</code> written somewhere else to complete an exit.
The current version of this bootstrap is made entirely by mail corruption and below is the mail message with the words replaced by their hexadecimal indexes:</p>
<div class="highlight"><pre><span></span><code>0200 0200
0000 1200
003F 0A00
003F 1A00
0000
</code></pre></div>
<p>Which is interpreted as:</p>
<div class="highlight"><pre><span></span><code>02000200    ANDEQ r0, #0x0 ; encoding ensures resulting bad egg is visible
12000000    ANDNE r0, #0x0
0A00003F    B pc+0x104 ; jumps to ~3 box slots ahead
1A00003F    B pc+0x104
</code></pre></div>
<h2 id="acknowledgements">Acknowledgements</h2>
<ul>
<li><a href="https://github.com/pret/">pret</a> (Pokémon Reverse Engineering Tools) for the <code>pokefirered</code> decompilation which allowed me to make sense of the exit</li>
<li>Adrichu00 for clarifying to me how the game handles the task call when a glitch Pokémon with a long name is involved</li>
<li><a href="https://youtube.com/@pokemerrp">merrp</a> for showing various tricks which allowed </li>
<li>RationalPsycho for suggesting the use of mail to shorten the process of writing payloads</li>
<li><a href="https://youtube.com/@Sleipnir17">Sleipnir17</a> for the <code>BX r0</code> set up code which has been adapted for <code>BX lr</code></li>
<li><a href="https://mlaurent.ovh/">E-Sh4rk</a> for his <a href="https://e-sh4rk.github.io/CodeGenerator/">CodeGenerator</a> which was used to create many of the box name codes</li>
<li><a href="https://youtube.com/@RETIREglitch">RETIRE</a> for suggesting a better way to jump to a return address in Thumb (<code>POP {pc}</code>)</li>
<li><a href="https://www.youtube.com/@detelony">デテロニー</a> for the <a href="https://www.youtube.com/watch?v=i9d4AyI2l1A">Japanese FR/LG ACE setup</a> which also convinced me to use <code>POP {pc}</code>.</li>
<li>Mettrich on the Glitch City Research Institute Discord server for creating the improved box 14 exit.</li>
</ul>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="April 12, 2025 13:46:13">April 12, 2025</span>
  </span>

    
    
    
    
      
  <span class="md-source-file__fact">
    
      
  <span class="md-icon" title="Contributors">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"/></svg>
  </span>
  <span>GitHub</span>

    
    <nav>
      
        <a href="https://github.com/it-is-final" class="md-author" title="@it-is-final">
          
          <img src="https://avatars.githubusercontent.com/u/52998298?v=4&size=72" alt="it-is-final">
        </a>
      
      
      
    </nav>
  </span>

    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      <p xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/"><span property="dct:title">pokemon-ace-notes</span> is licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">CC BY-SA 4.0<img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1" alt=""><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1" alt=""><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1" alt=""></a></p>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate"], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>